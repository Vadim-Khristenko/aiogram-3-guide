
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
  <script src="https://telegram.org/js/telegram-web-app.js?35"></script>
  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', () => {
      const webapp = window.Telegram.WebApp;
      
      // Initialize Telegram WebApp
      webapp.ready();
      webapp.expand();
      webapp.disableVerticalSwipes();
      
      // Handle navigation based on start_param
      const initData = webapp.initDataUnsafe;
      
      if (window.location.pathname === "/aiogram-3-guide/" && Object.hasOwn(initData, 'auth_date')) {
        if (initData.start_param) {
          // Map of start parameters to their corresponding paths
          const routeMap = {
            // Main sections
            'quickstart': 'quickstart',
            'messages': 'messages',
            'buttons': 'buttons',
            'routers': 'routers',
            'special-updates': 'special-updates',
            'fsm': 'fsm',
            'inline-mode': 'inline-mode',
            
            // Filters and middlewares
            'filters': 'filters-and-middlewares/#filters',
            'middlewares': 'filters-and-middlewares/#middlewares',
            'magic-filter': 'filters-and-middlewares/#magic-filters',
            'magic': 'filters-and-middlewares/#magic-filters',
            
            // Message handling
            'entities': 'messages/#message-entities',
            'escaping': 'messages/#input-escaping',
            'keep-formatting': 'messages/#keep-formatting',
            'send-files': 'messages/#uploading-media',
            'upload': 'messages/#uploading-media',
            'download-files': 'messages/#downloading-media',
            'download': 'messages/#downloading-media',
            'hide-image': 'messages/#bonus',
            
            // Buttons
            'callback-factory': 'buttons/#callback-factory',
            
            // Special updates
            'my-chat-member': 'special-updates/#my-chat-member',
            'chat-member': 'special-updates/#chat-member'
          };
          
          const path = routeMap[initData.start_param] || '/';
          const targetUrl = `${window.location.origin}${window.location.pathname}${path}`;
          
          window.location.href = targetUrl;
        }
      }
    });
  </script>

  
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Buttons">
      
      
        <meta name="author" content="MasterGroosha, Translated by VAI">
      
      
        <link rel="canonical" href="https://mastergroosha.github.io/aiogram-3-guide/en/buttons/">
      
      
        <link rel="prev" href="../messages/">
      
      
        <link rel="next" href="../routers/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.15">
    

    
      
        <title>Buttons - Writing Telegram Bots with aiogram 3.x</title>
      
    
    
  
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
  <style>
    /* ==================================================================
       TRANSLATION NOTIFICATION STYLES
       ================================================================== */
    
    /* Language notification */
    .language-notification {
      margin: 1.5em 0 2em 0;
      border-left-width: 4px;
      border-left-color: var(--md-primary-fg-color) !important;
      border-radius: 0 8px 8px 0;
      background: linear-gradient(90deg, rgba(var(--md-primary-fg-color--rgb), 0.1) 0%, transparent 100%);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Translation status notification */
    .translation-status {
      margin: 1.5em 0 2em 0;
      border-radius: 8px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Icons styling */
    .language-icon svg,
    .status-icon svg,
    .github-icon svg,
    .issue-icon svg {
      width: 20px;
      height: 20px;
      vertical-align: middle;
      margin-right: 8px;
      fill: currentColor;
      transition: transform 0.2s ease;
    }
    
    /* Content sections */
    .translation-notification-content {
      margin-top: 1em;
    }
    
    .translation-fallback-message {
      margin-bottom: 1.5em;
      padding: 1em;
      background: rgba(var(--md-default-fg-color--rgb), 0.05);
      border-radius: 6px;
      border-left: 3px solid var(--md-primary-fg-color);
    }
    
    .help-translation-section {
      margin-top: 1.5em;
      padding: 1.5em;
      background: rgba(var(--md-primary-fg-color--rgb), 0.03);
      border-radius: 8px;
      border: 1px solid rgba(var(--md-primary-fg-color--rgb), 0.1);
    }
    
    .help-translation-section h4 {
      margin: 0 0 0.5em 0;
      color: var(--md-primary-fg-color);
      font-weight: 600;
    }
    
    .help-translation-section p {
      margin: 0.5em 0;
      color: var(--md-default-fg-color--light);
    }
    
    /* Action buttons */
    .translation-actions {
      display: flex;
      gap: 0.75em;
      margin-top: 1.5em;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .md-button {
      border-radius: 6px;
      padding: 0.6em 1.2em;
      text-decoration: none;
      font-weight: 500;
      font-size: 0.9rem;
      letter-spacing: 0.02em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      border: 1px solid transparent;
      min-width: 140px;
    }
    
    .md-button--primary {
      background: var(--md-primary-fg-color);
      color: var(--md-primary-bg-color);
      box-shadow: 0 2px 4px rgba(var(--md-primary-fg-color--rgb), 0.3);
    }
    
    .md-button--primary:hover {
      background: var(--md-primary-fg-color--dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(var(--md-primary-fg-color--rgb), 0.4);
    }
    
    .md-button--secondary {
      background: transparent;
      color: var(--md-default-fg-color);
      border-color: var(--md-default-fg-color--lighter);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .md-button--secondary:hover {
      background: var(--md-default-fg-color--lightest);
      border-color: var(--md-default-fg-color--light);
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    }
    
    .md-button:active {
      transform: translateY(0);
    }
    
    .md-button:hover .github-icon svg,
    .md-button:hover .issue-icon svg {
      transform: scale(1.1);
    }
    
    .button-text {
      margin-left: 0.25em;
    }
    
    /* Status specific styling */
    .translation-status[data-status="in_progress"] {
      border-left-color: var(--md-warning-fg-color);
    }
    
    .translation-status[data-status="dropped"] {
      border-left-color: var(--md-default-fg-color--light);
    }
    
    .translation-status[data-status="need_help"] {
      border-left-color: var(--md-accent-fg-color);
    }
    
    .translation-status[data-status="complete_except_images"] {
      border-left-color: var(--md-success-fg-color);
    }
    
    .translation-status[data-status="unique_content"] {
      border-left-color: var(--md-accent-fg-color);
    }
    
    /* Help section */
    .status-help-section {
      margin-top: 1em;
      padding: 1em;
      background: rgba(var(--md-default-fg-color--rgb), 0.03);
      border-radius: 6px;
      border-left: 3px solid var(--md-accent-fg-color);
    }
    
    .status-help-section ul {
      margin: 0.5em 0;
      padding-left: 1.5em;
    }
    
    .status-help-section li {
      margin: 0.25em 0;
      color: var(--md-default-fg-color--light);
    }
    
    .contact-info {
      margin-top: 1em;
      font-size: 0.9em;
      color: var(--md-default-fg-color--light);
    }
    
    .contact-info a {
      color: var(--md-primary-fg-color);
      text-decoration: none;
      font-weight: 500;
    }
    
    .contact-info a:hover {
      text-decoration: underline;
    }
    
    /* Responsive design */
    @media screen and (max-width: 768px) {
      .translation-actions {
        flex-direction: column;
        align-items: center;
      }
      
      .md-button {
        width: 100%;
        max-width: 280px;
      }
      
      .help-translation-section {
        padding: 1em;
      }
    }
    
    /* Dark theme adjustments */
    [data-md-color-scheme="slate"] .translation-fallback-message {
      background: rgba(255, 255, 255, 0.05);
    }
    
    [data-md-color-scheme="slate"] .help-translation-section {
      background: rgba(255, 255, 255, 0.03);
      border-color: rgba(255, 255, 255, 0.1);
    }
    
    [data-md-color-scheme="slate"] .status-help-section {
      background: rgba(255, 255, 255, 0.03);
    }
    
    [data-md-color-scheme="slate"] .md-button--primary {
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }
    
    [data-md-color-scheme="slate"] .md-button--primary:hover {
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    }
    
    [data-md-color-scheme="slate"] .md-button--secondary {
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    
    [data-md-color-scheme="slate"] .md-button--secondary:hover {
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }
    
    /* Animation for status changes */
    @keyframes statusFadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .translation-status {
      animation: statusFadeIn 0.4s ease-out;
    }
    
    /* Print styles */
    @media print {
      .language-notification,
      .translation-status {
        break-inside: avoid;
        page-break-inside: avoid;
      }
      
      .translation-actions {
        display: none;
      }
    }
  </style>

    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/timeago.css">
    
      <link rel="stylesheet" href="../../css/timeago.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  
  
    
  

  
  
    
  

  <!-- Open Graph Meta Tags -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Writing Telegram Bots with aiogram 3.x - Buttons">
  <meta property="og:description" content="Buttons">
  <meta property="og:url" content="https://mastergroosha.github.io/aiogram-3-guide/en/buttons/">
  <meta property="og:image" content="https://mastergroosha.github.io/aiogram-3-guide/images/social.png">
  <meta property="og:image:type" content="image/png">
  <meta property="og:image:width" content="512">
  <meta property="og:image:height" content="512">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://mastergroosha.github.io/aiogram-3-guide/en/buttons/">
  <meta name="twitter:title" content="Writing Telegram Bots with aiogram 3.x - Buttons">
  <meta name="twitter:description" content="Buttons">
  <meta name="twitter:image" content="https://mastergroosha.github.io/aiogram-3-guide/images/social.png">

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="purple" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#buttons" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../" title="Writing Telegram Bots with aiogram 3.x" class="md-header__button md-logo" aria-label="Writing Telegram Bots with aiogram 3.x" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2M7.5 13A2.5 2.5 0 0 0 5 15.5 2.5 2.5 0 0 0 7.5 18a2.5 2.5 0 0 0 2.5-2.5A2.5 2.5 0 0 0 7.5 13m9 0a2.5 2.5 0 0 0-2.5 2.5 2.5 2.5 0 0 0 2.5 2.5 2.5 2.5 0 0 0 2.5-2.5 2.5 2.5 0 0 0-2.5-2.5"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Writing Telegram Bots with aiogram 3.x
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Buttons
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="purple" data-md-color-accent="indigo"  aria-label="Switch to Dark Theme"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to Dark Theme" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="purple" data-md-color-accent="indigo"  aria-label="Switch to Light Theme"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to Light Theme" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="Select language">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="../../buttons/" hreflang="ru" class="md-select__link">
              Русский
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="./" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../uk/buttons/" hreflang="uk" class="md-select__link">
              Українська
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/MasterGroosha/aiogram-3-guide" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    MasterGroosha/aiogram-3-guide
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<!-- Determine classes -->




<!-- Navigation -->
<nav
  class="md-nav md-nav--primary"
  aria-label="Navigation"
  data-md-level="0"
>

  <!-- Site title -->
  <label class="md-nav__title" for="__drawer">
    <a
      href="../"
      title="Writing Telegram Bots with aiogram 3.x"
      class="md-nav__button md-logo"
      aria-label="Writing Telegram Bots with aiogram 3.x"
      data-md-component="logo"
    >
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2M7.5 13A2.5 2.5 0 0 0 5 15.5 2.5 2.5 0 0 0 7.5 18a2.5 2.5 0 0 0 2.5-2.5A2.5 2.5 0 0 0 7.5 13m9 0a2.5 2.5 0 0 0-2.5 2.5 2.5 2.5 0 0 0 2.5 2.5 2.5 2.5 0 0 0 2.5-2.5 2.5 2.5 0 0 0-2.5-2.5"/></svg>

    </a>
    Contents
  </label>

  <!-- Repository information -->
  
    <div class="md-nav__source">
      <a href="https://github.com/MasterGroosha/aiogram-3-guide" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    MasterGroosha/aiogram-3-guide
  </div>
</a>
    </div>
  

  <!-- Navigation list -->
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../about-translation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    About Translation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started with aiogram
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../messages/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Working with Messages
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Buttons
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Buttons
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#reply-buttons" class="md-nav__link">
    <span class="md-ellipsis">
      Regular Buttons
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Regular Buttons">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reply-as-text" class="md-nav__link">
    <span class="md-ellipsis">
      Buttons as Templates
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reply-builder" class="md-nav__link">
    <span class="md-ellipsis">
      Keyboard Builder
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reply-special" class="md-nav__link">
    <span class="md-ellipsis">
      Special Regular Buttons
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inline-buttons" class="md-nav__link">
    <span class="md-ellipsis">
      Inline Buttons
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Inline Buttons">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#url-buttons" class="md-nav__link">
    <span class="md-ellipsis">
      URL Buttons
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callback-buttons" class="md-nav__link">
    <span class="md-ellipsis">
      Callbacks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callback-factory" class="md-nav__link">
    <span class="md-ellipsis">
      Callback Factory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callback-autoreply" class="md-nav__link">
    <span class="md-ellipsis">
      Auto-reply to Callbacks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../routers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Routers. Structure
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../filters-and-middlewares/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Filters and Middlewares
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../special-updates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Special Updates
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Finite State Machines
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../inline-mode/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Inline Mode
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../payments/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Payments
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../advanced-teaser/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    🔒 Advanced Level
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#reply-buttons" class="md-nav__link">
    <span class="md-ellipsis">
      Regular Buttons
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Regular Buttons">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reply-as-text" class="md-nav__link">
    <span class="md-ellipsis">
      Buttons as Templates
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reply-builder" class="md-nav__link">
    <span class="md-ellipsis">
      Keyboard Builder
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reply-special" class="md-nav__link">
    <span class="md-ellipsis">
      Special Regular Buttons
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inline-buttons" class="md-nav__link">
    <span class="md-ellipsis">
      Inline Buttons
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Inline Buttons">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#url-buttons" class="md-nav__link">
    <span class="md-ellipsis">
      URL Buttons
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callback-buttons" class="md-nav__link">
    <span class="md-ellipsis">
      Callbacks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callback-factory" class="md-nav__link">
    <span class="md-ellipsis">
      Callback Factory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callback-autoreply" class="md-nav__link">
    <span class="md-ellipsis">
      Auto-reply to Callbacks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
  <!-- Translation status notifications for non-Russian pages -->
  
    
    <!-- Language availability notification -->
    
    
    <!-- Translation status notification -->
    
  
  
  
                  


  
  


<div><h1 id="buttons">Buttons<a class="headerlink" href="#buttons" title="Permanent link">¶</a></h1>
<div class="admonition info">
<p>Using aiogram version: 3.7.0<br>
Tested on aiogram version: 3.21.0 | 07.07.2025</p>
</div>
<p>In this chapter, we will explore the wonderful feature of Telegram bots known as buttons. 
First, to avoid confusion, let's define the terms. 
What attaches to the bottom of your device's screen, 
we'll call <strong>regular</strong> buttons, and what attaches directly to messages, 
we'll call <strong>inline</strong> buttons. Here's a picture to illustrate:</p>
<p><img alt="Two types of buttons" src="../../images/en/buttons/l03_1.png"></p>
<details>
<summary>P.S: Recreated by the translator.</summary>
<p>I had to recreate this code since it was not originally in the guide. :(
</p><div class="highlight"><pre><span></span><code><span id="__code-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="s2">"buttons_example"</span><span class="p">))</span>
</span><span id="__code-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">examples_buttons</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
</span><span id="__code-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">kbr</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">ReplyKeyboardMarkup</span><span class="p">(</span>
</span><span id="__code-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="n">keyboard</span><span class="o">=</span><span class="p">[</span>
</span><span id="__code-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>            <span class="p">[</span>
</span><span id="__code-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>                <span class="n">types</span><span class="o">.</span><span class="n">KeyboardButton</span><span class="p">(</span>
</span><span id="__code-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>                    <span class="n">text</span><span class="o">=</span><span class="s1">'This is a "Regular" button'</span>
</span><span id="__code-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>                <span class="p">)</span>
</span><span id="__code-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>            <span class="p">]</span>
</span><span id="__code-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="p">],</span>
</span><span id="__code-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__code-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="p">)</span>
</span><span id="__code-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="n">kbi</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span>
</span><span id="__code-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="n">inline_keyboard</span><span class="o">=</span><span class="p">[</span>
</span><span id="__code-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>            <span class="p">[</span>
</span><span id="__code-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>                <span class="n">types</span><span class="o">.</span><span class="n">InlineKeyboardButton</span><span class="p">(</span>
</span><span id="__code-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>                    <span class="n">text</span><span class="o">=</span><span class="s1">'This is an Inline button'</span><span class="p">,</span>
</span><span id="__code-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>                    <span class="n">url</span><span class="o">=</span><span class="s2">"https://vadim-khristenko.github.io/aiogram-3-guide/en/buttons/"</span>
</span><span id="__code-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>                    <span class="c1"># Failure to specify one of the Optional parameters will</span>
</span><span id="__code-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>                    <span class="c1"># result in an error.</span>
</span><span id="__code-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>                <span class="p">)</span>
</span><span id="__code-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>            <span class="p">]</span>
</span><span id="__code-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>        <span class="p">]</span>
</span><span id="__code-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="p">)</span>
</span><span id="__code-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>    <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span>
</span><span id="__code-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="n">text</span><span class="o">=</span><span class="s2">"This is a message with an Inline button below it"</span><span class="p">,</span>
</span><span id="__code-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="n">reply_markup</span><span class="o">=</span><span class="n">kbi</span>
</span><span id="__code-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>    <span class="p">)</span>
</span><span id="__code-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>    <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span>
</span><span id="__code-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>        <span class="n">text</span><span class="o">=</span><span class="s2">"------------------"</span><span class="p">,</span>
</span><span id="__code-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="n">reply_markup</span><span class="o">=</span><span class="n">kbr</span>
</span><span id="__code-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="p">)</span>
</span></code></pre></div>
</details>
<h2 id="reply-buttons">Regular Buttons<a class="headerlink" href="#reply-buttons" title="Permanent link">¶</a></h2>
<h3 id="reply-as-text">Buttons as Templates<a class="headerlink" href="#reply-as-text" title="Permanent link">¶</a></h3>
<p>This type of button appeared with the Bot API back in 2015 and is essentially message templates (with a few special cases, which we'll discuss later). 
The principle is simple: whatever is written on the button will be sent to the current chat. 
Accordingly, to handle the pressing of such a button, the bot needs to recognize incoming text messages.</p>
<p>Let's write a handler that will send a message with two buttons when the <code>/start</code> command is pressed:</p>
<div class="highlight"><pre><span></span><code><span id="__code-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="s2">"start"</span><span class="p">))</span>
</span><span id="__code-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cmd_start</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
</span><span id="__code-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>    <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__code-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>        <span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">KeyboardButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">"With mashed potatoes"</span><span class="p">)],</span>
</span><span id="__code-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>        <span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">KeyboardButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">"Without mashed potatoes"</span><span class="p">)]</span>
</span><span id="__code-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>    <span class="p">]</span>
</span><span id="__code-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>    <span class="n">keyboard</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">ReplyKeyboardMarkup</span><span class="p">(</span><span class="n">keyboard</span><span class="o">=</span><span class="n">kb</span><span class="p">)</span>
</span><span id="__code-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>    <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span>
</span><span id="__code-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>        <span class="s2">"How should the cutlets be served?"</span><span class="p">,</span> 
</span><span id="__code-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>        <span class="n">reply_markup</span><span class="o">=</span><span class="n">keyboard</span>
</span><span id="__code-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>    <span class="p">)</span>
</span></code></pre></div>
<div class="admonition info">
<p>Although the Telegram Bot API <a href="https://core.telegram.org/bots/api#keyboardbutton">allows</a> using plain strings instead of <code>KeyboardButton</code> objects, 
attempting to use a string in aiogram 3.x will throw a validation error. 
This is not a bug, but a feature.</p>
<details>
<summary>Why does a validation error occur?</summary>
<blockquote>
<p>Translated by VAI. <a href="https://t.me/aiogram_pcr/1/920453">Source</a></p>
</blockquote>
<p>Gabben, [29.12.2021 12:35]
Instead of "1", you need to use <code>KeyboardButton(text="1")</code>.</p>
<p>Groosha, [29.12.2021 12:35]
Then it looks like an issue with Aiogram.</p>
<p>Gabben, [29.12.2021 12:37]
This will break our codegen.</p>
</details>
<p>Now you have to live with it 🤷‍♂️</p>
</div>
<p>Alright, let's run the bot and marvel at the enormous buttons:</p>
<p><img alt="Very large regular buttons" src="../../images/en/buttons/l03_2.png"></p>
<p>It doesn't look very neat. Firstly, we want to make the buttons smaller, and secondly, arrange them horizontally.<br>
Why are they so big in the first place? The thing is, by default, 
the "button" keyboard should take up as much space on smartphones as the regular letter keyboard. 
To reduce the size of the buttons, you need to specify an additional parameter <code>resize_keyboard=True</code> to the keyboard object.<br>
But how do you replace vertical buttons with horizontal ones? 
From the perspective of the Bot API, a keyboard is an <a href="https://core.telegram.org/bots/api#replykeyboardmarkup">array of arrays</a> of buttons, 
or to put it simply, an array of rows. Let's rewrite our code to make it look nice, 
and for added emphasis, we'll add the <code>input_field_placeholder</code> parameter, 
which will replace the text in the empty input field when the regular keyboard is active:</p>
<div class="highlight"><pre><span></span><code><span id="__code-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="s2">"start"</span><span class="p">))</span>
</span><span id="__code-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cmd_start</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
</span><span id="__code-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    <span class="n">kb</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__code-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>        <span class="p">[</span>
</span><span id="__code-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>            <span class="n">types</span><span class="o">.</span><span class="n">KeyboardButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">"With mashed potatoes"</span><span class="p">),</span>
</span><span id="__code-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>            <span class="n">types</span><span class="o">.</span><span class="n">KeyboardButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">"Without mashed potatoes"</span><span class="p">)</span>
</span><span id="__code-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>        <span class="p">],</span>
</span><span id="__code-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>    <span class="p">]</span>
</span><span id="__code-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>    <span class="n">keyboard</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">ReplyKeyboardMarkup</span><span class="p">(</span>
</span><span id="__code-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>        <span class="n">keyboard</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span>
</span><span id="__code-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>        <span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__code-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>        <span class="n">input_field_placeholder</span><span class="o">=</span><span class="s2">"Choose a serving method"</span>
</span><span id="__code-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>    <span class="p">)</span>
</span><span id="__code-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>    <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span>
</span><span id="__code-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>        <span class="s2">"How should the cutlets be served?"</span><span class="p">,</span> 
</span><span id="__code-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>        <span class="n">reply_markup</span><span class="o">=</span><span class="n">keyboard</span>
</span><span id="__code-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>    <span class="p">)</span>
</span></code></pre></div>
<p>Looking at it now — it indeed looks nice:</p>
<p><img alt="Buttons in one row" src="../../images/en/buttons/l03_3.png"></p>
<p>All that's left is to teach the bot to respond to pressing such buttons. 
As mentioned earlier, you need to check for an exact text match. 
We'll do this using the <em>magic filter</em> <code>F</code>, which we'll discuss in <a href="../filters-and-middlewares/#magic-filters">another chapter</a>:</p>
<div class="highlight"><pre><span></span><code><span id="__code-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># new import!</span>
</span><span id="__code-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aiogram</span><span class="w"> </span><span class="kn">import</span> <span class="n">F</span>
</span><span id="__code-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
</span><span id="__code-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"with mashed potatoes"</span><span class="p">)</span>
</span><span id="__code-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">with_puree</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
</span><span id="__code-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>    <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">"Excellent choice!"</span><span class="p">)</span>
</span><span id="__code-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>
</span><span id="__code-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"without mashed potatoes"</span><span class="p">)</span>
</span><span id="__code-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">without_puree</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
</span><span id="__code-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>    <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">"That's not tasty!"</span><span class="p">)</span>
</span></code></pre></div>
<p><img alt="Button press reaction" src="../../images/en/buttons/l03_4.png"></p>
<p>To remove the buttons, you need to send a new message with a special "removing" keyboard of type <code>ReplyKeyboardRemove</code>. 
For example: <code>await message.reply("Excellent choice!", reply_markup=types.ReplyKeyboardRemove())</code></p>
<h3 id="reply-builder">Keyboard Builder<a class="headerlink" href="#reply-builder" title="Permanent link">¶</a></h3>
<p>For more dynamic button generation, you can use a keyboard builder. The following methods will be useful:</p>
<ul>
<li><code>add(&lt;KeyboardButton&gt;)</code> — adds a button to the builder's memory;</li>
<li><code>adjust(int1, int2, int3...)</code> — arranges rows with <code>int1, int2, int3...</code> buttons;</li>
<li><code>as_markup()</code> — returns the ready keyboard object;</li>
<li><code>button(&lt;params&gt;)</code> — adds a button with specified parameters, automatically determining the button type (Reply or Inline).</li>
</ul>
<p>Let's create a numbered keyboard of size 4×4:</p>
<div class="highlight"><pre><span></span><code><span id="__code-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># new import!</span>
</span><span id="__code-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aiogram.utils.keyboard</span><span class="w"> </span><span class="kn">import</span> <span class="n">ReplyKeyboardBuilder</span>
</span><span id="__code-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
</span><span id="__code-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="s2">"reply_builder"</span><span class="p">))</span>
</span><span id="__code-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">reply_builder</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
</span><span id="__code-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>    <span class="n">builder</span> <span class="o">=</span> <span class="n">ReplyKeyboardBuilder</span><span class="p">()</span>
</span><span id="__code-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">):</span>
</span><span id="__code-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>        <span class="n">builder</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">KeyboardButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
</span><span id="__code-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>    <span class="n">builder</span><span class="o">.</span><span class="n">adjust</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span><span id="__code-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>    <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span>
</span><span id="__code-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>        <span class="s2">"Choose a number:"</span><span class="p">,</span>
</span><span id="__code-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>        <span class="n">reply_markup</span><span class="o">=</span><span class="n">builder</span><span class="o">.</span><span class="n">as_markup</span><span class="p">(</span><span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="__code-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>    <span class="p">)</span>
</span></code></pre></div>
<p><img alt="Result of the button builder" src="../../images/en/buttons/reply_builder.png"></p>
<div class="admonition info">
<p>The <a href="https://core.telegram.org/bots/api#replykeyboardmarkup">ReplyKeyboardMarkup</a> object also has two useful options: 
<code>one_time_keyboard</code> for automatically hiding the keyboard after a button is pressed, 
and <code>selective</code> for displaying the keyboard only to certain members of a group. 
Their usage is left for self-study.</p>
</div>
<h3 id="reply-special">Special Regular Buttons<a class="headerlink" href="#reply-special" title="Permanent link">¶</a></h3>
<p>As of the writing of this chapter, 
Telegram supports six special types of regular buttons that are not just regular message templates. 
They are designed for:</p>
<ul>
<li>Sending the current location;</li>
<li>Sending the user's contact with a phone number;</li>
<li>Creating a poll/quiz;</li>
<li>Selecting and sending user data to the bot based on specified criteria;</li>
<li>Selecting and sending (super)group or channel data to the bot based on specified criteria;</li>
<li>Launching a WebApp.</li>
</ul>
<p>Let's discuss them in more detail.</p>
<p><strong>Sending Current Location</strong>: 
This is straightforward; it sends the user's current coordinates. 
This is static location data, not the Live Location, which updates automatically. 
Users can fake their location at the system level (Android).</p>
<p><strong>Sending User Contact with Phone Number</strong>: 
When the button is pressed (with prior confirmation), 
the user sends their contact with a phone number to the bot. 
Users can ignore the button and send any contact, 
but you can handle this by verifying in the handler 
or filter that <code>message.contact.user_id == message.from_user.id</code>.</p>
<p><strong>Creating a Poll/Quiz</strong>:
When the button is pressed, the user is prompted to create a poll or quiz, 
which is then sent to the current chat. 
You need to pass a <a href="https://core.telegram.org/bots/api#keyboardbuttonpolltype">KeyboardButtonPollType</a> object. 
The optional <code>type</code> argument specifies the poll type (poll or quiz).</p>
<p><strong>Selecting and Sending User Data to the Bot</strong>: 
Displays a window to select a user from the chat list of the user who pressed the button. 
You need to pass a <a href="https://core.telegram.org/bots/api#keyboardbuttonrequestuser">KeyboardButtonRequestUser</a> object with a generated request ID and criteria, 
such as "is bot," "has Telegram Premium," etc. 
After selecting a user, the bot receives a <a href="https://core.telegram.org/bots/api#usershared">UserShared</a> service message.</p>
<p><strong>Selecting and Sending Chat Data to the Bot</strong>: 
Displays a window to select a chat from the chat list of the user who pressed the button. 
You need to pass a <a href="https://core.telegram.org/bots/api#keyboardbuttonrequestchat">KeyboardButtonRequestChat</a> object with a generated request ID and criteria, 
such as "is a group or channel," "user is chat creator," etc. 
After selecting a chat, the bot receives a <a href="https://core.telegram.org/bots/api#chatshared">ChatShared</a> service message.</p>
<p><strong>Launching a WebApp</strong>: 
When the button is pressed, it opens a <a href="https://core.telegram.org/bots/webapps">WebApp</a>. 
You need to pass a <a href="https://core.telegram.org/bots/api#webappinfo">WebAppInfo</a> object. 
WebApps will not be covered in this book.</p>
<p>Here's some code for illustration:
</p><div class="highlight"><pre><span></span><code><span id="__code-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="s2">"special_buttons"</span><span class="p">))</span>
</span><span id="__code-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cmd_special_buttons</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
</span><span id="__code-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>    <span class="n">builder</span> <span class="o">=</span> <span class="n">ReplyKeyboardBuilder</span><span class="p">()</span>
</span><span id="__code-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>    <span class="c1"># The row method explicitly forms a row</span>
</span><span id="__code-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>    <span class="c1"># of one or more buttons. For example, the first row</span>
</span><span id="__code-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>    <span class="c1"># will consist of two buttons...</span>
</span><span id="__code-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>    <span class="n">builder</span><span class="o">.</span><span class="n">row</span><span class="p">(</span>
</span><span id="__code-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>        <span class="n">types</span><span class="o">.</span><span class="n">KeyboardButton</span><span class="p">(</span>
</span><span id="__code-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>            <span class="n">text</span><span class="o">=</span><span class="s2">"Request Location"</span><span class="p">,</span> 
</span><span id="__code-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>            <span class="n">request_location</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__code-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>        <span class="p">),</span>
</span><span id="__code-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>        <span class="n">types</span><span class="o">.</span><span class="n">KeyboardButton</span><span class="p">(</span>
</span><span id="__code-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>            <span class="n">text</span><span class="o">=</span><span class="s2">"Request Contact"</span><span class="p">,</span> 
</span><span id="__code-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>            <span class="n">request_contact</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__code-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>        <span class="p">)</span>
</span><span id="__code-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>    <span class="p">)</span>
</span><span id="__code-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>    <span class="c1"># ... the second row consists of one button ...</span>
</span><span id="__code-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>    <span class="n">builder</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">KeyboardButton</span><span class="p">(</span>
</span><span id="__code-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>        <span class="n">text</span><span class="o">=</span><span class="s2">"Create Quiz"</span><span class="p">,</span>
</span><span id="__code-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>        <span class="n">request_poll</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">KeyboardButtonPollType</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">"quiz"</span><span class="p">))</span>
</span><span id="__code-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>    <span class="p">)</span>
</span><span id="__code-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>    <span class="c1"># ... and the third row again consists of two buttons</span>
</span><span id="__code-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>    <span class="n">builder</span><span class="o">.</span><span class="n">row</span><span class="p">(</span>
</span><span id="__code-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>        <span class="n">types</span><span class="o">.</span><span class="n">KeyboardButton</span><span class="p">(</span>
</span><span id="__code-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>            <span class="n">text</span><span class="o">=</span><span class="s2">"Select Premium User"</span><span class="p">,</span>
</span><span id="__code-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>            <span class="n">request_user</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">KeyboardButtonRequestUser</span><span class="p">(</span>
</span><span id="__code-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>                <span class="n">request_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="__code-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>                <span class="n">user_is_premium</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__code-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>            <span class="p">)</span>
</span><span id="__code-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>        <span class="p">),</span>
</span><span id="__code-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>        <span class="n">types</span><span class="o">.</span><span class="n">KeyboardButton</span><span class="p">(</span>
</span><span id="__code-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>            <span class="n">text</span><span class="o">=</span><span class="s2">"Select Supergroup with Forums"</span><span class="p">,</span>
</span><span id="__code-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>            <span class="n">request_chat</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">KeyboardButtonRequestChat</span><span class="p">(</span>
</span><span id="__code-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>                <span class="n">request_id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="__code-5-35"><a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>                <span class="n">chat_is_channel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__code-5-36"><a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>                <span class="n">chat_is_forum</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__code-5-37"><a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>            <span class="p">)</span>
</span><span id="__code-5-38"><a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>        <span class="p">)</span>
</span><span id="__code-5-39"><a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>    <span class="p">)</span>
</span><span id="__code-5-40"><a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>    <span class="c1"># No WebApps yet, sorry :(</span>
</span><span id="__code-5-41"><a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>
</span><span id="__code-5-42"><a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>    <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span>
</span><span id="__code-5-43"><a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>        <span class="s2">"Choose an action:"</span><span class="p">,</span>
</span><span id="__code-5-44"><a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>        <span class="n">reply_markup</span><span class="o">=</span><span class="n">builder</span><span class="o">.</span><span class="n">as_markup</span><span class="p">(</span><span class="n">resize_keyboard</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="__code-5-45"><a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>    <span class="p">)</span>
</span></code></pre></div>
<p><img alt="Special Regular Buttons" src="../../images/en/buttons/special_buttons.png"></p>
<p>Finally, two handler templates for handling button presses from the bottom two buttons:</p>
<div class="highlight"><pre><span></span><code><span id="__code-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># new import</span>
</span><span id="__code-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aiogram</span><span class="w"> </span><span class="kn">import</span> <span class="n">F</span>
</span><span id="__code-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>
</span><span id="__code-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">user_shared</span><span class="p">)</span>
</span><span id="__code-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">on_user_shared</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
</span><span id="__code-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>    <span class="nb">print</span><span class="p">(</span>
</span><span id="__code-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>        <span class="sa">f</span><span class="s2">"Request </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">user_shared</span><span class="o">.</span><span class="n">request_id</span><span class="si">}</span><span class="s2">. "</span>
</span><span id="__code-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>        <span class="sa">f</span><span class="s2">"User ID: </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">user_shared</span><span class="o">.</span><span class="n">user_id</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__code-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>    <span class="p">)</span>
</span><span id="__code-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>
</span><span id="__code-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>
</span><span id="__code-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">chat_shared</span><span class="p">)</span>
</span><span id="__code-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">on_chat_shared</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
</span><span id="__code-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>    <span class="nb">print</span><span class="p">(</span>
</span><span id="__code-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>        <span class="sa">f</span><span class="s2">"Request </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">chat_shared</span><span class="o">.</span><span class="n">request_id</span><span class="si">}</span><span class="s2">. "</span>
</span><span id="__code-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>        <span class="sa">f</span><span class="s2">"Chat ID: </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">chat_shared</span><span class="o">.</span><span class="n">chat_id</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__code-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>    <span class="p">)</span>
</span></code></pre></div>
<h2 id="inline-buttons">Inline Buttons<a class="headerlink" href="#inline-buttons" title="Permanent link">¶</a></h2>
<h3 id="url-buttons">URL Buttons<a class="headerlink" href="#url-buttons" title="Permanent link">¶</a></h3>
<p>Unlike regular buttons, inline buttons are attached not to the bottom of the screen but to the message they were sent with. 
In this chapter, we will look at two types of such buttons: URL and Callback. 
Another type — Switch — will be considered in the chapter on <a href="../inline-mode/">inline mode</a>.</p>
<div class="admonition info">
<p>Login and Pay buttons will not be covered in this book at all. If anyone is willing to help with at least 
working code for authorization or payment, please create a Pull Request on 
<a href="https://github.com/MasterGroosha/aiogram-3-guide">GitHub</a>. Thank you!</p>
</div>
<p>The simplest inline buttons are of the URL type, i.e., "link". 
Only HTTP(S) and tg:// protocols are supported.</p>
<div class="highlight"><pre><span></span><code><span id="__code-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># new import</span>
</span><span id="__code-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aiogram.utils.keyboard</span><span class="w"> </span><span class="kn">import</span> <span class="n">InlineKeyboardBuilder</span>
</span><span id="__code-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
</span><span id="__code-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="s2">"inline_url"</span><span class="p">))</span>
</span><span id="__code-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cmd_inline_url</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">,</span> <span class="n">bot</span><span class="p">:</span> <span class="n">Bot</span><span class="p">):</span>
</span><span id="__code-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>    <span class="n">builder</span> <span class="o">=</span> <span class="n">InlineKeyboardBuilder</span><span class="p">()</span>
</span><span id="__code-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>    <span class="n">builder</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">InlineKeyboardButton</span><span class="p">(</span>
</span><span id="__code-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>        <span class="n">text</span><span class="o">=</span><span class="s2">"GitHub"</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s2">"https://github.com"</span><span class="p">)</span>
</span><span id="__code-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>    <span class="p">)</span>
</span><span id="__code-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>    <span class="n">builder</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">InlineKeyboardButton</span><span class="p">(</span>
</span><span id="__code-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>        <span class="n">text</span><span class="o">=</span><span class="s2">"Official Telegram Channel"</span><span class="p">,</span>
</span><span id="__code-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>        <span class="n">url</span><span class="o">=</span><span class="s2">"tg://resolve?domain=telegram"</span><span class="p">)</span>
</span><span id="__code-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>    <span class="p">)</span>
</span><span id="__code-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>
</span><span id="__code-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>    <span class="c1"># To be able to show the ID button,</span>
</span><span id="__code-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>    <span class="c1"># The user must have the has_private_forwards flag set to False</span>
</span><span id="__code-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>    <span class="n">user_id</span> <span class="o">=</span> <span class="mi">1234567890</span>
</span><span id="__code-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>    <span class="n">chat_info</span> <span class="o">=</span> <span class="k">await</span> <span class="n">bot</span><span class="o">.</span><span class="n">get_chat</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="__code-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">chat_info</span><span class="o">.</span><span class="n">has_private_forwards</span><span class="p">:</span>
</span><span id="__code-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>        <span class="n">builder</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">InlineKeyboardButton</span><span class="p">(</span>
</span><span id="__code-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>            <span class="n">text</span><span class="o">=</span><span class="s2">"Some User"</span><span class="p">,</span>
</span><span id="__code-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>            <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s2">"tg://user?id=</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__code-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>        <span class="p">)</span>
</span><span id="__code-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>
</span><span id="__code-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>    <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span>
</span><span id="__code-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>        <span class="s1">'Choose a link'</span><span class="p">,</span>
</span><span id="__code-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>        <span class="n">reply_markup</span><span class="o">=</span><span class="n">builder</span><span class="o">.</span><span class="n">as_markup</span><span class="p">(),</span>
</span><span id="__code-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>    <span class="p">)</span>
</span></code></pre></div>
<p>Let's take a closer look at the middle block of code. The fact is that in March 2019, 
Telegram developers <a href="https://telegram.org/blog/unsend-privacy-emoji#anonymous-forwarding">added the ability</a> to disable user profile 
links in forwarded messages. When trying to create a URL button with a user ID who has disabled forwarding links, 
the bot will receive an error <code>Bad Request: BUTTON_USER_PRIVACY_RESTRICTED</code>. 
Therefore, before displaying such a button, it is necessary to check the state of this setting. 
To do this, you can call the <a href="https://core.telegram.org/bots/api#getchat">getChat</a> method and check the state of the <code>has_private_forwards</code> field 
in the response. If it is <code>True</code>, then the attempt to add a URL-ID button will result in an error.</p>
<h3 id="callback-buttons">Callbacks<a class="headerlink" href="#callback-buttons" title="Permanent link">¶</a></h3>
<p>There isn't much more to discuss about URL buttons, so let's move on to the highlight of today's program — Callback buttons. 
These are very powerful and can be found almost everywhere. Reaction buttons on posts (likes), menus in @BotFather, etc. 
The essence is that callback buttons have a special value (data) by which your application recognizes what was pressed and what needs to be done. 
Choosing the right data is <strong>very important</strong>! It is also worth noting that, unlike regular buttons, pressing a callback button 
allows you to do almost anything, from ordering pizza to launching computations on a supercomputer cluster.</p>
<p>Let's write a handler that will send a message with a callback button on the <code>/random</code> command:
</p><div class="highlight"><pre><span></span><code><span id="__code-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="s2">"random"</span><span class="p">))</span>
</span><span id="__code-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cmd_random</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
</span><span id="__code-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>    <span class="n">builder</span> <span class="o">=</span> <span class="n">InlineKeyboardBuilder</span><span class="p">()</span>
</span><span id="__code-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>    <span class="n">builder</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">InlineKeyboardButton</span><span class="p">(</span>
</span><span id="__code-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>        <span class="n">text</span><span class="o">=</span><span class="s2">"Press me"</span><span class="p">,</span>
</span><span id="__code-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>        <span class="n">callback_data</span><span class="o">=</span><span class="s2">"random_value"</span><span class="p">)</span>
</span><span id="__code-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>    <span class="p">)</span>
</span><span id="__code-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>    <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span>
</span><span id="__code-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>        <span class="s2">"Press the button for the bot to send a number from 1 to 10"</span><span class="p">,</span>
</span><span id="__code-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>        <span class="n">reply_markup</span><span class="o">=</span><span class="n">builder</span><span class="o">.</span><span class="n">as_markup</span><span class="p">()</span>
</span><span id="__code-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>    <span class="p">)</span>
</span></code></pre></div>
<p>But how do we handle the press? If earlier we used a handler on <code>message</code> to handle incoming messages, now 
we will use a handler on <code>callback_query</code> to handle callbacks. We will focus on the button's "value", i.e., its data:</p>
<div class="highlight"><pre><span></span><code><span id="__code-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="nd">@dp</span><span class="o">.</span><span class="n">callback_query</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">"random_value"</span><span class="p">)</span>
</span><span id="__code-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send_random_value</span><span class="p">(</span><span class="n">callback</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">CallbackQuery</span><span class="p">):</span>
</span><span id="__code-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    <span class="k">await</span> <span class="n">callback</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)))</span>
</span></code></pre></div>
<p><img alt="Reaction to pressing the callback button" src="../../images/en/buttons/l03_5.png"></p>
<p>Oh, why is the button pulsing with white? It turns out that the Telegram server is waiting for us to confirm the delivery of the callback, otherwise, within 30 seconds, it will highlight the button with an animated effect (pulsing white or in a different color depending on the client theme). To stop this animation, you need to call the <code>answer()</code> method on the callback (or use the API method <code>answer_callback_query()</code>). In general, you can call the <code>answer()</code> method without any arguments, but you can also call a special window (pop-up or overlay):</p>
<div class="highlight"><pre><span></span><code><span id="__code-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nd">@dp</span><span class="o">.</span><span class="n">callback_query</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">"random_value"</span><span class="p">)</span>
</span><span id="__code-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send_random_value</span><span class="p">(</span><span class="n">callback</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">CallbackQuery</span><span class="p">):</span>
</span><span id="__code-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>    <span class="k">await</span> <span class="n">callback</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)))</span>
</span><span id="__code-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    <span class="k">await</span> <span class="n">callback</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span>
</span><span id="__code-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>        <span class="n">text</span><span class="o">=</span><span class="s2">"Thank you for using the bot!"</span><span class="p">,</span>
</span><span id="__code-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>        <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__code-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>    <span class="p">)</span>
</span><span id="__code-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>    <span class="c1"># or just await callback.answer()</span>
</span></code></pre></div>
<p><img alt="Pop-up window when pressing the callback button" src="../../images/en/buttons/l03_6.png"></p>
<p>The reader may wonder: at what point in the processing should we respond to the callback with the <code>answer()</code> method? In general, the main thing is to simply not forget to inform Telegram about receiving the callback request, but I recommend placing 
the <code>answer()</code> call at the very end, and here's why: if an error occurs during the callback processing and 
the bot encounters an unhandled exception, the user will see the pulsing button animation for half a minute and understand that something 
is wrong. Otherwise, the animation will stop, and the user will remain unaware of whether their request was successfully processed or not.</p>
<div class="admonition info">
<p class="admonition-title">Note</p>
<p>In the <code>send_random_value</code> function, we called the <code>answer()</code> method not on <code>message</code>, but on <code>callback.message</code>. This is because 
callback handlers work not with messages (type <a href="https://core.telegram.org/bots/api#message">Message</a>), 
but with callbacks (type <a href="https://core.telegram.org/bots/api#callbackquery">CallbackQuery</a>), which have different fields, and 
the message itself is just a part of it. Also, note that <code>message</code> is the message to which the 
button was attached (i.e., the sender of such a message is the bot itself). If you want to know who pressed the button, look at 
the <code>from</code> field (in your code, it will be <code>callback.from_user</code>, as the word <code>from</code> is reserved in Python).</p>
</div>
<div class="admonition warning">
<p class="admonition-title">About the <code>message</code> object in the callback</p>
<p>If the message was sent from <a href="../inline-mode/">inline mode</a>, the <code>message</code> field in the callback will be empty. 
You will not be able to get the content of such a message unless you save it somewhere in advance.</p>
</div>
<p>Let's move on to a more complex example. Suppose the user is offered a message with the number 0, and below it are three buttons: +1, -1, and Confirm. 
With the first two, they can edit the number, and the last one removes the entire keyboard, fixing the changes. We will store the values in 
memory in a dictionary (we will talk about finite state machines <em>another time</em>).</p>
<div class="highlight"><pre><span></span><code><span id="__code-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1"># This is where user data is stored.</span>
</span><span id="__code-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="c1"># Since this is an in-memory dictionary, it will be cleared upon restart</span>
</span><span id="__code-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="n">user_data</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__code-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>
</span><span id="__code-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_keyboard</span><span class="p">():</span>
</span><span id="__code-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>    <span class="n">buttons</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__code-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>        <span class="p">[</span>
</span><span id="__code-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>            <span class="n">types</span><span class="o">.</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">"-1"</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">"num_decr"</span><span class="p">),</span>
</span><span id="__code-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>            <span class="n">types</span><span class="o">.</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">"+1"</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">"num_incr"</span><span class="p">)</span>
</span><span id="__code-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>        <span class="p">],</span>
</span><span id="__code-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>        <span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">"Confirm"</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">"num_finish"</span><span class="p">)]</span>
</span><span id="__code-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>    <span class="p">]</span>
</span><span id="__code-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>    <span class="n">keyboard</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">inline_keyboard</span><span class="o">=</span><span class="n">buttons</span><span class="p">)</span>
</span><span id="__code-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>    <span class="k">return</span> <span class="n">keyboard</span>
</span><span id="__code-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>
</span><span id="__code-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>
</span><span id="__code-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_num_text</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">,</span> <span class="n">new_value</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="__code-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>    <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">edit_text</span><span class="p">(</span>
</span><span id="__code-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>        <span class="sa">f</span><span class="s2">"Specify the number: </span><span class="si">{</span><span class="n">new_value</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
</span><span id="__code-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>        <span class="n">reply_markup</span><span class="o">=</span><span class="n">get_keyboard</span><span class="p">()</span>
</span><span id="__code-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>    <span class="p">)</span>
</span><span id="__code-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>
</span><span id="__code-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>
</span><span id="__code-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a><span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="s2">"numbers"</span><span class="p">))</span>
</span><span id="__code-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cmd_numbers</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
</span><span id="__code-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a>    <span class="n">user_data</span><span class="p">[</span><span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__code-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>    <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">"Specify the number: 0"</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">get_keyboard</span><span class="p">())</span>
</span><span id="__code-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>
</span><span id="__code-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a>
</span><span id="__code-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a><span class="nd">@dp</span><span class="o">.</span><span class="n">callback_query</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"num_"</span><span class="p">))</span>
</span><span id="__code-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">callbacks_num</span><span class="p">(</span><span class="n">callback</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">CallbackQuery</span><span class="p">):</span>
</span><span id="__code-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a>    <span class="n">user_value</span> <span class="o">=</span> <span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">callback</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__code-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a>    <span class="n">action</span> <span class="o">=</span> <span class="n">callback</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"_"</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__code-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a>
</span><span id="__code-11-35"><a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a>    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">"incr"</span><span class="p">:</span>
</span><span id="__code-11-36"><a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a>        <span class="n">user_data</span><span class="p">[</span><span class="n">callback</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_value</span><span class="o">+</span><span class="mi">1</span>
</span><span id="__code-11-37"><a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a>        <span class="k">await</span> <span class="n">update_num_text</span><span class="p">(</span><span class="n">callback</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">user_value</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__code-11-38"><a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a>    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">"decr"</span><span class="p">:</span>
</span><span id="__code-11-39"><a id="__codelineno-11-39" name="__codelineno-11-39" href="#__codelineno-11-39"></a>        <span class="n">user_data</span><span class="p">[</span><span class="n">callback</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_value</span><span class="o">-</span><span class="mi">1</span>
</span><span id="__code-11-40"><a id="__codelineno-11-40" name="__codelineno-11-40" href="#__codelineno-11-40"></a>        <span class="k">await</span> <span class="n">update_num_text</span><span class="p">(</span><span class="n">callback</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">user_value</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__code-11-41"><a id="__codelineno-11-41" name="__codelineno-11-41" href="#__codelineno-11-41"></a>    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">"finish"</span><span class="p">:</span>
</span><span id="__code-11-42"><a id="__codelineno-11-42" name="__codelineno-11-42" href="#__codelineno-11-42"></a>        <span class="k">await</span> <span class="n">callback</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">edit_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Total: </span><span class="si">{</span><span class="n">user_value</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__code-11-43"><a id="__codelineno-11-43" name="__codelineno-11-43" href="#__codelineno-11-43"></a>
</span><span id="__code-11-44"><a id="__codelineno-11-44" name="__codelineno-11-44" href="#__codelineno-11-44"></a>    <span class="k">await</span> <span class="n">callback</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
</span></code></pre></div>
<p>And it seems to work:</p>
<p><img alt="Everything works?" src="../../images/en/buttons/l03_7.png"></p>
<p>But now imagine that a cunning user did the following: called the <code>/numbers</code> command (value 0), increased the value 
to 1, called <code>/numbers</code> again (the value reset to 0), and edited and pressed the "+1" button on the first message. 
What will happen? The bot will honestly send a request to edit the text with the value 1, but since the message 
already has the number 1, the Bot API will return an error that the old and new texts match, and the bot will catch an exception: 
<code>Bad Request: message is not modified: specified new message content and reply markup are exactly the same 
as a current content and reply markup of the message</code></p>
<p><img alt="BadRequest error under certain circumstances" src="../../images/en/buttons/l03_8.png"></p>
<p>You will likely encounter this error often at first when trying to edit messages. 
Generally speaking, such an error often indicates problems with the logic of generating/updating data in the message, but sometimes, 
as in the example above, it can be expected behavior. </p>
<p>In this case, we will ignore the error entirely, as we only care about 
the final result, which will definitely be correct. The <strong>MessageNotModified</strong> error belongs to the Bad Request category, 
so we have a choice: ignore the entire class of such errors, or catch the entire BadRequest class 
and try to identify the specific cause by the error text. 
To avoid complicating the example too much, we will use the first method and slightly update the <code>update_num_text()</code> function:</p>
<div class="highlight"><pre><span></span><code><span id="__code-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1"># New imports!</span>
</span><span id="__code-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">suppress</span>
</span><span id="__code-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aiogram.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">TelegramBadRequest</span>
</span><span id="__code-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>
</span><span id="__code-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_num_text</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">,</span> <span class="n">new_value</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="__code-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>    <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="n">TelegramBadRequest</span><span class="p">):</span>
</span><span id="__code-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>        <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">edit_text</span><span class="p">(</span>
</span><span id="__code-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>            <span class="sa">f</span><span class="s2">"Specify the number: </span><span class="si">{</span><span class="n">new_value</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
</span><span id="__code-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>            <span class="n">reply_markup</span><span class="o">=</span><span class="n">get_keyboard</span><span class="p">()</span>
</span><span id="__code-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>        <span class="p">)</span>
</span></code></pre></div>
<p>If you now try to repeat the example above, the bot will simply ignore the specified exception in this block of code.</p>
<h3 id="callback-factory">Callback Factory<a class="headerlink" href="#callback-factory" title="Permanent link">¶</a></h3>
<p>When you operate with some simple callbacks with a common prefix, like <code>order_1</code>, <code>order_2</code>... it may seem 
easy to call <code>split()</code> and split the string by some delimiter. But now imagine that you need 
to store not one value, but three: <code>order_1_1994_2731519</code>. What is the article, price, quantity here? Or maybe it's the year of release? 
And splitting the string starts to look scary: <code>.split("_")[2]</code>. Why not 1 or 3? </p>
<p>At some point, there is a need to structure the content of such callback data, and aiogram has a solution! 
You create <code>CallbackData</code> objects, specify a prefix, describe the structure, and then the framework independently assembles 
the string with callback data and, more importantly, correctly parses the incoming value. Let's understand this with a specific example; 
we will create a <code>NumbersCallbackFactory</code> class with the prefix <code>fabnum</code> and two fields <code>action</code> and <code>value</code>. The <code>action</code> field determines 
what to do, change the value (change) or fix it (finish), and the <code>value</code> field shows by how much to change 
the value. By default, it will be None, as the "finish" action does not require a change delta. Code:</p>
<div class="highlight"><pre><span></span><code><span id="__code-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># new imports!</span>
</span><span id="__code-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
</span><span id="__code-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aiogram.filters.callback_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">CallbackData</span>
</span><span id="__code-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>
</span><span id="__code-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">NumbersCallbackFactory</span><span class="p">(</span><span class="n">CallbackData</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">"fabnum"</span><span class="p">):</span>
</span><span id="__code-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>    <span class="n">action</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__code-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>    <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span></code></pre></div>
<p>Our class must inherit from <code>CallbackData</code> and accept the prefix value. The prefix is 
a common substring at the beginning by which the framework will determine which structure is in the callback. </p>
<p>Now let's write the function to generate the keyboard. Here we will use the <code>button()</code> method, which will automatically 
create a button with the required type, and we only need to pass the arguments. 
As the <code>callback_data</code> argument, instead of a string, we will specify 
an instance of our <code>NumbersCallbackFactory</code> class:</p>
<div class="highlight"><pre><span></span><code><span id="__code-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_keyboard_fab</span><span class="p">():</span>
</span><span id="__code-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>    <span class="n">builder</span> <span class="o">=</span> <span class="n">InlineKeyboardBuilder</span><span class="p">()</span>
</span><span id="__code-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>    <span class="n">builder</span><span class="o">.</span><span class="n">button</span><span class="p">(</span>
</span><span id="__code-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>        <span class="n">text</span><span class="o">=</span><span class="s2">"-2"</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="n">NumbersCallbackFactory</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">"change"</span><span class="p">,</span> <span class="n">value</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
</span><span id="__code-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>    <span class="p">)</span>
</span><span id="__code-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>    <span class="n">builder</span><span class="o">.</span><span class="n">button</span><span class="p">(</span>
</span><span id="__code-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>        <span class="n">text</span><span class="o">=</span><span class="s2">"-1"</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="n">NumbersCallbackFactory</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">"change"</span><span class="p">,</span> <span class="n">value</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__code-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>    <span class="p">)</span>
</span><span id="__code-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>    <span class="n">builder</span><span class="o">.</span><span class="n">button</span><span class="p">(</span>
</span><span id="__code-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>        <span class="n">text</span><span class="o">=</span><span class="s2">"+1"</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="n">NumbersCallbackFactory</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">"change"</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__code-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>    <span class="p">)</span>
</span><span id="__code-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>    <span class="n">builder</span><span class="o">.</span><span class="n">button</span><span class="p">(</span>
</span><span id="__code-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>        <span class="n">text</span><span class="o">=</span><span class="s2">"+2"</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="n">NumbersCallbackFactory</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">"change"</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="__code-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>    <span class="p">)</span>
</span><span id="__code-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>    <span class="n">builder</span><span class="o">.</span><span class="n">button</span><span class="p">(</span>
</span><span id="__code-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>        <span class="n">text</span><span class="o">=</span><span class="s2">"Confirm"</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="n">NumbersCallbackFactory</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">"finish"</span><span class="p">)</span>
</span><span id="__code-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>    <span class="p">)</span>
</span><span id="__code-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>    <span class="c1"># Align buttons 4 per row to get 4 + 1</span>
</span><span id="__code-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>    <span class="n">builder</span><span class="o">.</span><span class="n">adjust</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span><span id="__code-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>    <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="n">as_markup</span><span class="p">()</span>
</span></code></pre></div>
<p>We leave the message sending and editing methods the same (we will add the <code>_fab</code> suffix to the names and commands):</p>
<div class="highlight"><pre><span></span><code><span id="__code-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_num_text_fab</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">,</span> <span class="n">new_value</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="__code-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>    <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="n">TelegramBadRequest</span><span class="p">):</span>
</span><span id="__code-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>        <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">edit_text</span><span class="p">(</span>
</span><span id="__code-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>            <span class="sa">f</span><span class="s2">"Specify the number: </span><span class="si">{</span><span class="n">new_value</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
</span><span id="__code-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>            <span class="n">reply_markup</span><span class="o">=</span><span class="n">get_keyboard_fab</span><span class="p">()</span>
</span><span id="__code-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>        <span class="p">)</span>
</span><span id="__code-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>
</span><span id="__code-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="s2">"numbers_fab"</span><span class="p">))</span>
</span><span id="__code-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cmd_numbers_fab</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
</span><span id="__code-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>    <span class="n">user_data</span><span class="p">[</span><span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__code-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>    <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">"Specify the number: 0"</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">get_keyboard_fab</span><span class="p">())</span>
</span></code></pre></div>
<p>Finally, we move on to the main part — handling callbacks. To do this, we need to pass the class whose callbacks we are catching 
to the decorator with the <code>filter()</code> method called. There is also an additional argument named <code>callback_data</code> 
(the name must be exactly this!), and it has the same type as the filtered class:</p>
<div class="highlight"><pre><span></span><code><span id="__code-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="nd">@dp</span><span class="o">.</span><span class="n">callback_query</span><span class="p">(</span><span class="n">NumbersCallbackFactory</span><span class="o">.</span><span class="n">filter</span><span class="p">())</span>
</span><span id="__code-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">callbacks_num_change_fab</span><span class="p">(</span>
</span><span id="__code-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>        <span class="n">callback</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">CallbackQuery</span><span class="p">,</span> 
</span><span id="__code-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>        <span class="n">callback_data</span><span class="p">:</span> <span class="n">NumbersCallbackFactory</span>
</span><span id="__code-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="p">):</span>
</span><span id="__code-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>    <span class="c1"># Current value</span>
</span><span id="__code-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>    <span class="n">user_value</span> <span class="o">=</span> <span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">callback</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__code-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>    <span class="c1"># If the number needs to be changed</span>
</span><span id="__code-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>    <span class="k">if</span> <span class="n">callback_data</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s2">"change"</span><span class="p">:</span>
</span><span id="__code-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>        <span class="n">user_data</span><span class="p">[</span><span class="n">callback</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_value</span> <span class="o">+</span> <span class="n">callback_data</span><span class="o">.</span><span class="n">value</span>
</span><span id="__code-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>        <span class="k">await</span> <span class="n">update_num_text_fab</span><span class="p">(</span><span class="n">callback</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">user_value</span> <span class="o">+</span> <span class="n">callback_data</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</span><span id="__code-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>    <span class="c1"># If the number needs to be fixed</span>
</span><span id="__code-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__code-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>        <span class="k">await</span> <span class="n">callback</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">edit_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Total: </span><span class="si">{</span><span class="n">user_value</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__code-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>    <span class="k">await</span> <span class="n">callback</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
</span></code></pre></div>
<p>Let's further specify our handlers and make a separate handler 
for numeric buttons and for the "Confirm" button. We will filter by the <code>action</code> value, and the "magic filters" of aiogram 3.x will help us with this. 
Seriously, they are called that: Magic Filter. We will discuss this magic in more detail 
in another chapter, but for now, let's just use the "magic" and take it on faith:</p>
<div class="highlight"><pre><span></span><code><span id="__code-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1"># new import!</span>
</span><span id="__code-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">magic_filter</span><span class="w"> </span><span class="kn">import</span> <span class="n">F</span>
</span><span id="__code-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>
</span><span id="__code-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="c1"># Pressing one of the buttons: -2, -1, +1, +2</span>
</span><span id="__code-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="nd">@dp</span><span class="o">.</span><span class="n">callback_query</span><span class="p">(</span><span class="n">NumbersCallbackFactory</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s2">"change"</span><span class="p">))</span>
</span><span id="__code-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">callbacks_num_change_fab</span><span class="p">(</span>
</span><span id="__code-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>        <span class="n">callback</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">CallbackQuery</span><span class="p">,</span> 
</span><span id="__code-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>        <span class="n">callback_data</span><span class="p">:</span> <span class="n">NumbersCallbackFactory</span>
</span><span id="__code-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="p">):</span>
</span><span id="__code-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>    <span class="c1"># Current value</span>
</span><span id="__code-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>    <span class="n">user_value</span> <span class="o">=</span> <span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">callback</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__code-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>
</span><span id="__code-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>    <span class="n">user_data</span><span class="p">[</span><span class="n">callback</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_value</span> <span class="o">+</span> <span class="n">callback_data</span><span class="o">.</span><span class="n">value</span>
</span><span id="__code-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>    <span class="k">await</span> <span class="n">update_num_text_fab</span><span class="p">(</span><span class="n">callback</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">user_value</span> <span class="o">+</span> <span class="n">callback_data</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</span><span id="__code-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>    <span class="k">await</span> <span class="n">callback</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
</span><span id="__code-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>
</span><span id="__code-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a>
</span><span id="__code-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a><span class="c1"># Pressing the "confirm" button</span>
</span><span id="__code-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a><span class="nd">@dp</span><span class="o">.</span><span class="n">callback_query</span><span class="p">(</span><span class="n">NumbersCallbackFactory</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s2">"finish"</span><span class="p">))</span>
</span><span id="__code-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">callbacks_num_finish_fab</span><span class="p">(</span><span class="n">callback</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">CallbackQuery</span><span class="p">):</span>
</span><span id="__code-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a>    <span class="c1"># Current value</span>
</span><span id="__code-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a>    <span class="n">user_value</span> <span class="o">=</span> <span class="n">user_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">callback</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__code-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a>
</span><span id="__code-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a>    <span class="k">await</span> <span class="n">callback</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">edit_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Total: </span><span class="si">{</span><span class="n">user_value</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__code-17-25"><a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a>    <span class="k">await</span> <span class="n">callback</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span>
</span></code></pre></div>
<p><img alt="Callback Factory" src="../images/en/buttons/callback_factory.png"></p>
<p>At first glance, what we did may seem complicated, but in reality, the callback factory allows 
you to create advanced callback buttons and conveniently break the code into logical entities. You can see the application of the factory 
in practice in the <a href="https://github.com/MasterGroosha/telegram-bombsweeper-bot">Minesweeper game bot</a>, 
written by your favorite author :)</p>
<h3 id="callback-autoreply">Auto-reply to Callbacks<a class="headerlink" href="#callback-autoreply" title="Permanent link">¶</a></h3>
<p>If you have a lot of callback handlers that need either a simple reply or a uniform reply, you can 
simplify your life a bit by using a special middleware. We will talk about such things 
<a href="../filters-and-middlewares/#middlewares">separately</a>, but for now, let's get acquainted.</p>
<p>So, the simplest option is to add this line after creating the dispatcher:</p>
<div class="highlight"><pre><span></span><code><span id="__code-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1"># don't forget the new import</span>
</span><span id="__code-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aiogram.utils.callback_answer</span><span class="w"> </span><span class="kn">import</span> <span class="n">CallbackAnswerMiddleware</span>
</span><span id="__code-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>
</span><span id="__code-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="n">dp</span> <span class="o">=</span> <span class="n">Dispatcher</span><span class="p">()</span>
</span><span id="__code-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="n">dp</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="n">CallbackAnswerMiddleware</span><span class="p">())</span>
</span></code></pre></div>
<p>In this case, after the handler is executed, aiogram will automatically respond to the callback. 
You can override 
<a href="https://github.com/aiogram/aiogram/blob/5adaf7a567e976da64e418eee5df31682ad2496c/aiogram/utils/callback_answer.py#L133-L137">default settings</a> 
and specify your own, for example: </p>
<div class="highlight"><pre><span></span><code><span id="__code-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">dp</span><span class="o">.</span><span class="n">callback_query</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span>
</span><span id="__code-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>    <span class="n">CallbackAnswerMiddleware</span><span class="p">(</span>
</span><span id="__code-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>        <span class="n">pre</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">"Done!"</span><span class="p">,</span> <span class="n">show_alert</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__code-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>    <span class="p">)</span>
</span><span id="__code-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="p">)</span>
</span></code></pre></div>
<p>Unfortunately, situations where all callback handlers have the same response are quite rare. Fortunately, overriding 
the middleware behavior in a specific handler is quite simple: just pass the <code>callback_answer</code> argument 
and set new values for it:</p>
<div class="highlight"><pre><span></span><code><span id="__code-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1"># new import!</span>
</span><span id="__code-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aiogram.utils.callback_answer</span><span class="w"> </span><span class="kn">import</span> <span class="n">CallbackAnswer</span>
</span><span id="__code-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>
</span><span id="__code-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="nd">@dp</span><span class="o">.</span><span class="n">callback_query</span><span class="p">()</span>
</span><span id="__code-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">my_handler</span><span class="p">(</span><span class="n">callback</span><span class="p">:</span> <span class="n">CallbackQuery</span><span class="p">,</span> <span class="n">callback_answer</span><span class="p">:</span> <span class="n">CallbackAnswer</span><span class="p">):</span>
</span><span id="__code-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>    <span class="o">...</span> <span class="c1"># some code here</span>
</span><span id="__code-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>    <span class="k">if</span> <span class="o">&lt;</span><span class="n">everything</span> <span class="ow">is</span> <span class="n">ok</span><span class="o">&gt;</span><span class="p">:</span>
</span><span id="__code-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>        <span class="n">callback_answer</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">"Great!"</span>
</span><span id="__code-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__code-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>        <span class="n">callback_answer</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">"Something went wrong. Try again later"</span>
</span><span id="__code-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>        <span class="n">callback_answer</span><span class="o">.</span><span class="n">cache_time</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="__code-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>    <span class="o">...</span> <span class="c1"># some code here</span>
</span></code></pre></div>
<p><strong>Important</strong>: this method will not work if the middleware has the <code>pre=True</code> flag set. In this case, you need to completely 
override the middleware parameter set through flags, which we will discuss 
<a href="../filters-and-middlewares/#flags">later</a>:</p>
<div class="highlight"><pre><span></span><code><span id="__code-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aiogram</span><span class="w"> </span><span class="kn">import</span> <span class="n">flags</span>
</span><span id="__code-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aiogram.utils.callback_answer</span><span class="w"> </span><span class="kn">import</span> <span class="n">CallbackAnswer</span>
</span><span id="__code-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>
</span><span id="__code-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="nd">@dp</span><span class="o">.</span><span class="n">callback_query</span><span class="p">()</span>
</span><span id="__code-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="nd">@flags</span><span class="o">.</span><span class="n">callback_answer</span><span class="p">(</span><span class="n">pre</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># override the pre flag</span>
</span><span id="__code-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">my_handler</span><span class="p">(</span><span class="n">callback</span><span class="p">:</span> <span class="n">CallbackQuery</span><span class="p">,</span> <span class="n">callback_answer</span><span class="p">:</span> <span class="n">CallbackAnswer</span><span class="p">):</span>
</span><span id="__code-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>    <span class="o">...</span> <span class="c1"># some code here</span>
</span><span id="__code-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>    <span class="k">if</span> <span class="o">&lt;</span><span class="n">everything</span> <span class="ow">is</span> <span class="n">ok</span><span class="o">&gt;</span><span class="p">:</span>
</span><span id="__code-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>        <span class="n">callback_answer</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">"Now this text will be visible!"</span>
</span><span id="__code-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>    <span class="o">...</span> <span class="c1"># some code here</span>
</span></code></pre></div>
<p>For now, we will conclude our acquaintance with buttons.</p></div>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="September 7, 2025 14:41:01 UTC"><span class="timeago" datetime="2025-09-07T14:41:01+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="September 7, 2025 14:41:01 UTC">2025-09-07</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="September 7, 2025 14:41:01 UTC"><span class="timeago" datetime="2025-09-07T14:41:01+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="September 7, 2025 14:41:01 UTC">2025-09-07</span>
  </span>

    
    
    
  </aside>





                

              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Original Copyright &copy; 2020-2025 Groosha, Translation Copyright &copy; 2024-2025 VAI
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://t.me/+DE0_2nCvbXozZjUy" target="_blank" rel="noopener" title="Chat in Telegram" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M248 8C111.033 8 0 119.033 0 256s111.033 248 248 248 248-111.033 248-248S384.967 8 248 8m114.952 168.66c-3.732 39.215-19.881 134.378-28.1 178.3-3.476 18.584-10.322 24.816-16.948 25.425-14.4 1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25 5.342-39.5 3.652-3.793 67.107-61.51 68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608 69.142-14.845 10.194-26.894 9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7 18.45-13.7 108.446-47.248 144.628-62.3c68.872-28.647 83.183-33.623 92.511-33.789 2.052-.034 6.639.474 9.61 2.885a10.45 10.45 0 0 1 3.53 6.716 43.8 43.8 0 0 1 .417 9.769"/></svg>
    </a>
  
    
    
    
    
    <a href="https://github.com/MasterGroosha/aiogram-3-guide" target="_blank" rel="noopener" title="GitHub" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.tabs.link", "content.code.copy"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.56ea9cef.min.js"></script>
      
        <script src="../../js/timeago.min.js"></script>
      
        <script src="../../js/timeago_mkdocs_material.js"></script>
      
        <script src="../../js/timeago.min.js"></script>
      
        <script src="../../js/timeago_mkdocs_material.js"></script>
      
    
  </body>
</html>